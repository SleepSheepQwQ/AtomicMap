name: Project Guard (证据记录仪)

on: [push, workflow_dispatch]

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 仓库定义核查 (带源码审计)
        run: |
          echo "==== 云端 settings.gradle.kts 实时内容如下 ===="
          cat settings.gradle.kts
          echo "=============================================="
          
          if grep -q "google()" settings.gradle.kts; then
            echo "✅ 审计通过：仓库定义确实存在。"
          else
            echo "❌ 证据确凿：settings.gradle.kts 确实缺少 google()！"
            echo "请检查你是否提交到了正确的分支，或文件是否在根目录。"
            exit 1
          fi

      - name: MainActivity 变量核查
        run: |
          echo "==== 检查 MainActivity.kt 逻辑 ===="
          if grep -q "unbindUserService(args" app/src/main/kotlin/com/atomic/map/MainActivity.kt; then
            if ! grep -q "val args =" app/src/main/kotlin/com/atomic/map/MainActivity.kt; then
               echo "错误代码片段展示："
               grep -C 5 "unbindUserService" app/src/main/kotlin/com/atomic/map/MainActivity.kt
               exit 1
            fi
          fi
